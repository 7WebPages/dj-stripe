{% extends "djstripe/base.html" %}
{% load static djstripe_tags %}

{% block title %}Choose a Subscription{% endblock title %}

{% block content %}

{% if not customer.current_subscription %}
<!-- Trial subscription area -->
<div class="col-xs-6 col-sm-6 col-md-3 col-lg-3">
    <div class="panel price panel-blue">
        <div class="panel-heading  text-center">
            <h3>Trial subscription</h3>
        </div>
        <div class="panel-body text-center">
            <p class="lead" style="font-size:30px">
            <strong>{{ config.TRIAL_PERIOD_DAYS }} trial days</strong></p>
        </div>
        <ul class="list-group list-group-flush text-center">
            <li class="list-group-item">
            {% for trial_description_item in trial_description_items %}
                <li class="list-group-item">{{ trial_description_item }}</li>
            {% endfor %}
            </li>
        </ul>
        <div class="panel-footer">
            {% if request.user.check_trial %}
            <p align="center" style="color: black;">Current Subscription</p>
            {% else %}
            <form action="{% url 'trial-subscribe' %}" method="post">{% csrf_token %}
                <button class="btn btn-lg btn-block btn-warning" type="submit">Subscribe trial</button>
            </form>
            {% endif %}
        </div>
    </div>
</div>
<!-- End trial subscription area -->
{% endif %}

{% for plan in plans %}
<div class="col-xs-6 col-sm-6 col-md-3 col-lg-3">
    <!-- PRICE ITEM -->
    <div class="panel price panel-blue">
        <div class="panel-heading  text-center">
            <h3>{{ plan.name }}</h3>
        </div>
        <div class="panel-body text-center">
            <p class="lead" style="font-size:40px"><strong>{{ plan.amount|floatformat:2 }}$ / {{ plan.interval }}</strong></p>
        </div>
        <ul class="list-group list-group-flush text-center">
            <li class="list-group-item">
            {% for description_item in plan.get_plan_description %}
                <li class="list-group-item">{{ description_item }}</li>
            {% endfor %}
            </li>
            {% if plan.trial_period_days %}
            <li class="list-group-item"><i class="icon-ok text-danger"></i> Trial Period {{ plan.trial_period_days }} days</li>
            {% endif %}
        </ul>
        <div class="panel-footer">
                        <form
                                {% if not customer.current_subscription or customer.current_subscription.status == CurrentSubscription.STATUS_CANCELLED and customer.current_subscription.amount == plan.amount %}
                                    action="{% url 'djstripe:subscribe' %}" class="djstripe-subscribe"
                                    data-key="{{ STRIPE_PUBLIC_KEY }}"
                                    data-amount="{{ plan.amount }}"
                                    data-name="{{ plan.name }}"
                                {% else %}
                                    data-stripe-key="{{ STRIPE_PUBLIC_KEY }}"
                                    action="{% url 'djstripe:change_plan' %}" class="djstripe-change-plan"
                                {% endif %}
                                    method="POST">


                            {% csrf_token %}
                            <input type="hidden" name="plan" value="{{ plan.stripe_id }}" />
                            <input name="stripe_token" type="hidden" />
                        {% if message %}
                        {{ message }}
                        {% else %}
                            <!-- disable this when clicked -->
                            {% if not customer.current_subscription or customer.current_subscription.status == CurrentSubscription.STATUS_CANCELLED %}
                                <!-- do nothing -->
                                <button class="btn btn-lg btn-block btn-warning" type="submit">Subscribe</button>
                            {% elif customer.current_subscription.amount < plan.amount|djdiv:100 %}
                                <button class="btn btn-lg btn-block btn-warning" type="submit">Subscribe</button>
                            {% elif customer.current_subscription.plan == plan.interval and customer.current_subscription.status != CurrentSubscription.STATUS_CANCELLED and customer.current_subscription.amount == plan.amount %}
                            <p align="center" style="color: black;">Current Subscription</p>
                            {% elif customer.current_subscription.amount > plan.amount|djdiv:100 %}
                                <button class="btn btn-lg btn-block btn-warning" type="submit">Subscribe</button>
                            {% endif %}
                        {% endif %}
                        </form>
        </div>
    </div>
    <!-- /PRICE ITEM -->
</div>
{% endfor %}
<div class="row row-centered cancel">
    {% if not customer.current_subscription %}
        {% if not request.user.check_trial %}
            <a href="{% url 'account-cancel' %}" class="btn btn-danger">Cancel</a>
        {% endif %}
    {% endif %}
</div>


{% endblock content %}

{% block extra_js %}
<script type="text/javascript">
    $(function() {
        $('.confirm').on('click', function(e) {
            e.preventDefault();
            if (window.confirm("Are you sure?")) {
                location.href = this.href;
            }
        });
    });
</script>
{% endblock extra_js %}

{% block javascript %}

{% if not cards %}
<script src="https://checkout.stripe.com/v2/checkout.js"></script>
<script text="text/javascript">
    $(function() {
        
        $('body').on("click", '.djstripe-subscribe button[type=submit]', function(e) {
          e.preventDefault();
          // retrieve current $(".djstripe-subscribe")
          var $form = $(e.target).parents('form'),
              token = function(res) {
                $form.find("input[name=stripe_token]").val(res.id);
                $("button[type=submit]").attr("disabled", "true");
                $('#in-progress').modal({"keyboard": false})
                $('.progress-bar').animate({width:'+=100%'}, 2000);
                $form.trigger("submit");
              };
          StripeCheckout.open({
            key:         "{{ STRIPE_PUBLIC_KEY }}",
            name:        'Subscribe',
            panelLabel:  'Subscribe',
            token:       token,
            email: '{{ request.user.email }}'
          });
          return false;
        });
        {% if plans|length > 1 %}
          $('.djstripe-change-plan').click(function(e){
              $("button[type=submit]").attr("disabled", "true");
              $('#in-progress').modal({"keyboard": false})
              $('.progress-bar').animate({width:'+=100%'}, 2000);
              var $form = $(this);
              $form.trigger("submit");
          });
        {% endif %}
    });
</script>
{% endif %}

{% endblock javascript %}
